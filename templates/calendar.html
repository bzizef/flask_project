{% extends "base.html" %}

{% block title %}Calendar{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header mb-4">
    <div class="row align-items-center">
        <div class="col">
            <h1 class="h3 mb-1"><i class="bi bi-calendar3 me-2"></i>Calendar</h1>
            <p class="text-muted mb-0">Manage your events and schedule</p>
        </div>
        <div class="col-auto">
            <a href="/export/calendar/csv" class="btn btn-outline-secondary me-2" title="Export to CSV">
                <i class="bi bi-download"></i>
            </a>
            <button class="btn btn-gradient" data-bs-toggle="modal" data-bs-target="#eventModal" onclick="openNewEvent()">
                <i class="bi bi-plus-lg me-1"></i>Add Event
            </button>
        </div>
    </div>
</div>

<!-- Calendar Navigation -->
<div class="card dashboard-card mb-4">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
            <a href="/calendar?year={{ year if month > 1 else year - 1 }}&month={{ month - 1 if month > 1 else 12 }}" 
               class="btn btn-outline-primary">
                <i class="bi bi-chevron-left"></i>
            </a>
            <h4 class="mb-0">{{ month_name }} {{ year }}</h4>
            <a href="/calendar?year={{ year if month < 12 else year + 1 }}&month={{ month + 1 if month < 12 else 1 }}" 
               class="btn btn-outline-primary">
                <i class="bi bi-chevron-right"></i>
            </a>
        </div>
    </div>
</div>

<!-- Calendar Grid -->
<div class="card dashboard-card">
    <div class="card-body p-0 p-md-3">
        <div class="calendar-grid">
            <!-- Header Row -->
            <div class="calendar-header-cell">Sun</div>
            <div class="calendar-header-cell">Mon</div>
            <div class="calendar-header-cell">Tue</div>
            <div class="calendar-header-cell">Wed</div>
            <div class="calendar-header-cell">Thu</div>
            <div class="calendar-header-cell">Fri</div>
            <div class="calendar-header-cell">Sat</div>
            
            <!-- Calendar Days -->
            {% for week in month_days %}
                {% for day in week %}
                    {% if day == 0 %}
                        <div class="calendar-day other-month"></div>
                    {% else %}
                        {% set date_str = '%04d-%02d-%02d' | format(year, month, day) %}
                        {% set is_today = (year == today.year and month == today.month and day == today.day) %}
                        <div class="calendar-day {% if is_today %}today{% endif %}" 
                             onclick="openNewEvent('{{ date_str }}')"
                             data-date="{{ date_str }}">
                            <div class="day-number">{{ day }}</div>
                            <div class="day-events">
                                {% if date_str in events_by_date %}
                                    {% for event in events_by_date[date_str][:3] %}
                                        <div class="day-event bg-{{ event.color }} text-white" 
                                             onclick="event.stopPropagation(); openEditEvent({{ event.id }})"
                                             title="{{ event.title }}">
                                            {{ event.title }}
                                        </div>
                                    {% endfor %}
                                    {% if events_by_date[date_str]|length > 3 %}
                                        <div class="day-event bg-secondary text-white">
                                            +{{ events_by_date[date_str]|length - 3 }} more
                                        </div>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            {% endfor %}
        </div>
    </div>
</div>

<!-- Event Modal -->
<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalTitle">
                    <i class="bi bi-calendar-plus me-2"></i>New Event
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="eventForm">
                    <input type="hidden" id="eventId">
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" id="eventTitle" required placeholder="Event title">
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" id="eventDate" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Time (optional)</label>
                            <input type="time" class="form-control" id="eventTime">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="eventDescription" rows="2" placeholder="Event details..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Color</label>
                        <div class="d-flex gap-2 flex-wrap">
                            <input type="radio" class="btn-check" name="eventColor" id="color-primary" value="primary" checked>
                            <label class="btn btn-outline-primary" for="color-primary">Blue</label>
                            
                            <input type="radio" class="btn-check" name="eventColor" id="color-success" value="success">
                            <label class="btn btn-outline-success" for="color-success">Green</label>
                            
                            <input type="radio" class="btn-check" name="eventColor" id="color-warning" value="warning">
                            <label class="btn btn-outline-warning" for="color-warning">Yellow</label>
                            
                            <input type="radio" class="btn-check" name="eventColor" id="color-danger" value="danger">
                            <label class="btn btn-outline-danger" for="color-danger">Red</label>
                            
                            <input type="radio" class="btn-check" name="eventColor" id="color-info" value="info">
                            <label class="btn btn-outline-info" for="color-info">Cyan</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger me-auto" id="deleteEventBtn" style="display: none;" onclick="deleteEvent()">
                    <i class="bi bi-trash"></i> Delete
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-gradient" onclick="saveEvent()">
                    <i class="bi bi-check-lg me-1"></i>Save Event
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
    
    function openNewEvent(date = null) {
        document.getElementById('eventModalTitle').innerHTML = '<i class="bi bi-calendar-plus me-2"></i>New Event';
        document.getElementById('eventId').value = '';
        document.getElementById('eventTitle').value = '';
        document.getElementById('eventDate').value = date || new Date().toISOString().split('T')[0];
        document.getElementById('eventTime').value = '';
        document.getElementById('eventDescription').value = '';
        document.querySelector('input[name="eventColor"][value="primary"]').checked = true;
        document.getElementById('deleteEventBtn').style.display = 'none';
    }
    
    async function openEditEvent(eventId) {
        try {
            const response = await fetch(`/api/events/${eventId}`);
            const event = await response.json();
            
            document.getElementById('eventModalTitle').innerHTML = '<i class="bi bi-pencil me-2"></i>Edit Event';
            document.getElementById('eventId').value = event.id;
            document.getElementById('eventTitle').value = event.title;
            document.getElementById('eventDate').value = event.date;
            document.getElementById('eventTime').value = event.time || '';
            document.getElementById('eventDescription').value = event.description || '';
            document.querySelector(`input[name="eventColor"][value="${event.color}"]`).checked = true;
            document.getElementById('deleteEventBtn').style.display = 'block';
            
            eventModal.show();
        } catch (error) {
            console.error('Error loading event:', error);
        }
    }
    
    async function saveEvent() {
        const eventId = document.getElementById('eventId').value;
        const eventData = {
            title: document.getElementById('eventTitle').value,
            date: document.getElementById('eventDate').value,
            time: document.getElementById('eventTime').value,
            description: document.getElementById('eventDescription').value,
            color: document.querySelector('input[name="eventColor"]:checked').value
        };
        
        if (!eventData.title || !eventData.date) {
            alert('Please fill in the title and date');
            return;
        }
        
        try {
            const url = eventId ? `/api/events/${eventId}` : '/api/events';
            const method = eventId ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(eventData)
            });
            
            if (response.ok) {
                eventModal.hide();
                location.reload();
            }
        } catch (error) {
            console.error('Error saving event:', error);
        }
    }
    
    async function deleteEvent() {
        const eventId = document.getElementById('eventId').value;
        if (!eventId) return;
        
        if (!confirm('Are you sure you want to delete this event?')) return;
        
        try {
            const response = await fetch(`/api/events/${eventId}`, { method: 'DELETE' });
            if (response.ok) {
                eventModal.hide();
                location.reload();
            }
        } catch (error) {
            console.error('Error deleting event:', error);
        }
    }
</script>
{% endblock %}
